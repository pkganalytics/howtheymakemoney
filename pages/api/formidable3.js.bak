import formidable from 'formidable';
const nodemailer = require('nodemailer');
const fs = require('fs');

export const config = {
	api: {
		bodyParser: false
	}
};

const transporter = nodemailer.createTransport({
	host: 'mail.gmx.com',
	port: 587,
	//secure: true, // true for 465, false for other ports
	auth: {
		user: 'itesentinel@gmx.com',
		pass: 'sitesentinel'
	},
	requireTLS: true
});

export default async (req, res) => {
	const form = new formidable.IncomingForm({ uploadDir: './uploads' });

	form.keepExtensions = true;
	form.multiples = true;
	form.maxFileSize = 20 * 1024 * 1024;

	form.on('end', () => {
		res.statusCode = 200;
		res.send('Thank you for your message!');
	});
	form.parse(req, (err, fields, files) => {
		const main = async (req, res) => {
			let sendMailObject = {
				from: 'sitesentinel@gmx.com',
				to: 'help@sitesentinel.com',
				subject: 'Query from ' + fields.firstname + ' ' + fields.surname, // Subject line
				text:
					'Message: ' +
					fields.message +
					' From: ' +
					fields.email +
					' Deadline: ' +
					fields.deadline +
					' days ',
				html:
					'<b>Message: </b>' +
					fields.message +
					'<br/><b>From: </b> ' +
					fields.email +
					'<br/><b>Deadline: </b> ' +
					fields.deadline +
					' days '
			};
			let attachments = [];
			if (typeof files.file1 !== 'undefined') {
				attachments.push({
					filename: files.file1.name,
					path: files.file1.path
				});
			}
			if (typeof files.file2 !== 'undefined') {
				attachments.push({
					filename: files.file2.name,
					path: files.file2.path
				});
			}
			if (typeof files.file3 !== 'undefined') {
				attachments.push({
					filename: files.file3.name,
					path: files.file3.path
				});
			}

			sendMailObject.attachments = attachments;

			await transporter.sendMail(sendMailObject);

			if (typeof files.file1 !== 'undefined') {
				fs.unlinkSync(files.file1.path);
			}

			if (typeof files.file2 !== 'undefined') {
				fs.unlinkSync(files.file2.path);
			}

			if (typeof files.file3 !== 'undefined') {
				fs.unlinkSync(files.file3.path);
			}
		};
		main(req, res);
	});
};
